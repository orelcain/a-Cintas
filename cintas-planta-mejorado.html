<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe T√©cnico - Cintas Transportadoras MEJORADO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-primary: #5499c7;
            --color-area: #85929e;
            --color-header: #34495e;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif; background: #f0f2f5; padding: 15px; font-size: 11px; line-height: 1.5; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { text-align: center; border-bottom: 3px solid #2c3e50; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { font-size: 22px; color: #2c3e50; margin-bottom: 8px; font-weight: 700; letter-spacing: 0.5px; }
        .subtitle { font-size: 12px; color: #7f8c8d; font-weight: 400; }
        
        /* Botones de acci√≥n */
        .export-buttons { 
            text-align: center; 
            margin-bottom: 15px; 
            padding: 12px 20px; 
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            flex-wrap: wrap;
            box-shadow: 0 4px 15px rgba(52, 73, 94, 0.3);
        }
        .btn { 
            padding: 8px 16px; 
            border: none;
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 11px; 
            font-weight: 600; 
            transition: all 0.3s;
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.25); }
        .btn-pdf { background: linear-gradient(135deg, #5d6d7e 0%, #34495e 100%); color: white; }
        .btn-excel { background: linear-gradient(135deg, #566573 0%, #34495e 100%); color: white; }
        .btn-primary { background: linear-gradient(135deg, #5499c7 0%, #2e86c1 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #85929e 0%, #5d6d7e 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #a6acaf 0%, #85929e 100%); color: white; }
        .btn-add-section { background: linear-gradient(135deg, #5499c7 0%, #2e86c1 100%); color: white; font-size: 13px; padding: 10px 20px; margin: 15px auto; display: block; }
        
        
        /* Secciones de cintas */
        .area-field {
            background: linear-gradient(135deg, #85929e 0%, #5d6d7e 100%);
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            width: 100%;
            display: block;
            border-radius: 6px;
            margin-bottom: 8px;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: text;
        }
        .area-field::placeholder { color: rgba(255,255,255,0.7); font-size: 12px; }
        
        .cinta-section { 
            margin-bottom: 25px; 
            border: 2px solid #ecf0f1; 
            padding: 15px; 
            padding-top: 8px;
            border-radius: 8px;
            background: #fafafa;
            position: relative;
            transition: all 0.3s;
        }
        .cinta-section:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .cinta-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; margin-left: 8px; }
        .cinta-title-editable { 
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white; 
            padding: 8px 12px; 
            font-size: 13px; 
            font-weight: 700;
            border: none; 
            flex-grow: 1;
            border-radius: 6px;
            margin-right: 10px;
        }
        .cinta-controls { display: flex; gap: 5px; }
        .btn-small { padding: 4px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; border: none; font-weight: 600; }
        .btn-move-up { background: #3498db; color: white; }
        .btn-move-down { background: #9b59b6; color: white; }
        .btn-delete-section { background: #e74c3c; color: white; }
        
        .cinta-content { display: grid; grid-template-columns: 35% 65%; gap: 15px; align-items: start; }
        
        /* Tablas din√°micas */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; background: white; border-radius: 6px; overflow: hidden; }
        th { background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%); padding: 8px 10px; text-align: left; font-weight: 700; border: 1px solid #95a5a6; font-size: 11px; color: #2c3e50; letter-spacing: 0.3px; }
        td { padding: 6px 8px; border: 1px solid #ecf0f1; vertical-align: middle; }
        .label-col { 
            background: #f8f9fa; 
            font-weight: 600; 
            width: 25%; 
            font-size: 11px; 
            color: #34495e;
            cursor: text;
            user-select: text;
            transition: background 0.2s;
        }
        .label-col:hover { background: #e8eef1; }
        .label-col:focus { 
            outline: 2px solid #5499c7;
            outline-offset: -2px;
            background: #fff;
        }
        .value-col { position: relative; } /* Sin ancho fijo, se distribuye proporcionalmente */
        .editable-field { 
            width: 100%; 
            border: 1px solid #dfe4ea; 
            padding: 6px 10px; 
            font-size: 11px;
            font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif;
            background: white;
            border-radius: 4px;
            resize: none;
            overflow: hidden;
            min-height: 20px;
            transition: border-color 0.3s;
        }
        .editable-field:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        
        .row-controls { 
            position: absolute; 
            right: -35px; 
            top: 50%; 
            transform: translateY(-50%);
            display: none;
            flex-direction: column;
            gap: 3px;
            z-index: 10;
        }
        tr:hover .row-controls { display: flex; }
        .btn-row { 
            width: 22px; 
            height: 22px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .btn-row:hover { transform: scale(1.15); box-shadow: 0 3px 6px rgba(0,0,0,0.25); }
        .btn-add-row { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
        .btn-delete-row { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .btn-add-col { background: #3498db; color: white; }
        .btn-delete-col { background: #e67e22; color: white; }
        
        .col-controls {
            position: relative;
            display: inline-flex;
            gap: 2px;
            margin-left: 5px;
            vertical-align: middle;
        }
        .btn-col {
            width: 18px;
            height: 18px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .table-controls { margin-top: 8px; display: flex; gap: 8px; }
        .section-subtitle { 
            background: linear-gradient(135deg, #5499c7 0%, #2e86c1 100%);
            color: white; 
            padding: 6px 10px; 
            font-size: 11px; 
            font-weight: 700;
            margin: 12px 0 8px 0; 
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Multimedia */
        .multimedia-section { background: white; padding: 12px; border-radius: 8px; border: 2px solid #ecf0f1; }
        .multimedia-title { 
            font-weight: 700;
            font-size: 11px; 
            margin-bottom: 8px; 
            color: #2c3e50;
            text-transform: uppercase;
            border-bottom: 2px solid #5499c7;
            padding-bottom: 5px;
        }
        .add-photo-btn { 
            padding: 6px 12px; 
            margin-bottom: 10px; 
            background: linear-gradient(135deg, #5499c7 0%, #2e86c1 100%);
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 10px; 
            font-weight: 700;
            transition: all 0.3s;
        }
        .add-photo-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        
        .image-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-bottom: 12px;
            align-items: flex-start;
        }
        .image-item { 
            border: 2px solid #ecf0f1; 
            border-radius: 6px; 
            background: white; 
            position: relative;
            cursor: move;
            transition: all 0.3s;
            display: inline-block;
            margin: 8px;
            min-width: 150px;
            min-height: 100px;
            overflow: hidden;
            vertical-align: top;
        }
        .image-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .image-item.dragging { opacity: 0.5; }
        .image-item img { 
            display: block; 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: white;
            pointer-events: none;
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Canvas de anotaciones */
        .annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 5;
            pointer-events: auto;
        }
        .annotation-canvas.disabled {
            pointer-events: none;
        }
        
        /* Herramientas de anotaci√≥n */
        .annotation-tools {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(44, 62, 80, 0.95);
            border-radius: 6px;
            padding: 5px;
            display: none;
            z-index: 10;
            flex-direction: column;
            gap: 3px;
        }
        .image-item:hover .annotation-tools {
            display: flex;
        }
        .annotation-tool-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: rgba(52, 152, 219, 0.8);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .annotation-tool-btn:hover {
            background: rgba(52, 152, 219, 1);
            transform: scale(1.1);
        }
        .annotation-tool-btn.active {
            background: rgba(46, 204, 113, 0.9);
        }
        .color-picker-mini {
            width: 30px;
            height: 30px;
            border: 2px solid white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .rotate-btn, .delete-btn, .zoom-controls { 
            position: absolute; 
            top: 5px;
            background: rgba(84, 153, 199, 0.95);
            color: white; 
            border: none; 
            border-radius: 4px; 
            padding: 4px 8px; 
            font-size: 13px;
            font-weight: 700;
            cursor: pointer; 
            z-index: 10;
            transition: all 0.2s;
        }
        .zoom-controls { left: 5px; display: flex; gap: 3px; padding: 3px 5px; }
        .rotate-btn { left: 75px; }
        .rotate-btn:hover { background: rgba(52, 152, 219, 1); transform: rotate(90deg); }
        .delete-btn { left: 110px; background: rgba(231, 76, 60, 0.95); }
        .delete-btn:hover { background: rgba(231, 76, 60, 1); }
        .zoom-btn { background: none; border: none; color: white; font-size: 16px; cursor: pointer; padding: 0 5px; font-weight: 700; }
        .zoom-btn:hover { color: #f1c40f; }
        
        .image-description-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            padding: 5px;
        }
        .image-description {
            width: 100%;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 10px;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            color: #2c3e50;
            outline: none;
        }
        .image-description:focus {
            background: white;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5);
        }
        .image-description::placeholder {
            color: #7f8c8d;
            font-size: 9px;
        }
        
        /* Metadatos y Encabezado */
        .metadata-section {
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #95a5a6;
        }
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .metadata-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .metadata-field label {
            font-size: 10px;
            font-weight: 700;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metadata-field input,
        .metadata-field textarea {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 11px;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: white;
            transition: all 0.3s;
        }
        .metadata-field input:focus,
        .metadata-field textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .metadata-title {
            font-size: 14px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-config-section {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
        }
        .header-config-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .logo-upload-area {
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.05);
        }
        .logo-upload-area:hover {
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.1);
        }
        .logo-preview {
            max-width: 100%;
            max-height: 80px;
            border-radius: 4px;
        }
        .header-info-fields {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .header-field label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        .header-field input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 11px;
        }
        .header-field input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .save-status { 
            position: fixed; 
            bottom: 25px; 
            right: 25px;
            background: rgba(52, 152, 219, 0.95);
            color: white; 
            padding: 12px 24px; 
            border-radius: 8px;
            font-size: 12px; 
            font-weight: 700;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .save-status.show { display: block; animation: slideIn 0.3s; }
        .save-status.saved { background: rgba(39, 174, 96, 0.95); }
        
        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(100px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; padding: 15px; }
            .export-buttons, .add-photo-btn, .btn-small, .cinta-controls, .table-controls, .row-controls, .col-controls { display: none !important; }
            .delete-btn, .rotate-btn, .zoom-controls { display: none !important; }
            .section-subtitle button, .section-subtitle div { display: none !important; }
            .image-item { page-break-inside: avoid; border: 1px solid #ddd !important; }
            .image-item img { max-width: 100% !important; height: auto !important; object-fit: contain !important; }
            .cinta-section { page-break-inside: avoid; border: 1px solid #ddd; }
            th[contenteditable], td[contenteditable] { border: none; }
        }
    </style>
</head>
<body>
    <div class="container" id="printable-content">
        <div class="header">
            <h1 contenteditable="true" oninput="autoSave()" style="cursor: text; outline: none;">üîß INFORME T√âCNICO - CINTAS TRANSPORTADORAS</h1>
            <p class="subtitle" contenteditable="true" oninput="autoSave()" style="cursor: text; outline: none;">Especificaciones y dimensiones de equipos | Fecha: <span contenteditable="true" style="border-bottom: 2px solid #5499c7; padding: 2px 8px; background: #ecf0f1; border-radius: 4px;">01/12/2025</span></p>
        </div>

        <!-- Secci√≥n de Encabezado Personalizado -->
        <div class="header-config-section">
            <div class="metadata-title" style="color: white;">üìã INFORMACI√ìN DE LA EMPRESA</div>
            <div class="header-config-grid">
                <div class="logo-upload-area" id="logoUploadArea" onclick="document.getElementById('logoInput').click()">
                    <img id="logoPreview" class="logo-preview" style="display: none;">
                    <div id="logoPlaceholder" style="padding: 20px; font-size: 11px; opacity: 0.8;">
                        üì∑ Click para subir logo<br><small>(Recomendado: 200x80px)</small>
                    </div>
                    <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                </div>
                <div class="header-info-fields">
                    <div class="header-field">
                        <label>Empresa</label>
                        <input type="text" id="empresaNombre" placeholder="Ej: PROCESADORA AV√çCOLA XYZ" oninput="autoSave()">
                    </div>
                    <div class="header-field">
                        <label>Planta</label>
                        <input type="text" id="plantaNombre" placeholder="Ej: Planta Principal - Filete" oninput="autoSave()">
                    </div>
                    <div class="header-field">
                        <label>Contacto</label>
                        <input type="text" id="contactoInfo" placeholder="Ej: Juan P√©rez - 555-1234" oninput="autoSave()">
                    </div>
                    <div class="header-field">
                        <label>Email</label>
                        <input type="email" id="emailInfo" placeholder="mantenimiento@empresa.com" oninput="autoSave()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Metadatos -->
        <div class="metadata-section">
            <div class="metadata-title">üìä INFORMACI√ìN DEL LEVANTAMIENTO</div>
            <div class="metadata-grid">
                <div class="metadata-field">
                    <label>Fecha de Inspecci√≥n</label>
                    <input type="date" id="fechaInspeccion" oninput="autoSave()">
                </div>
                <div class="metadata-field">
                    <label>T√©cnico Responsable</label>
                    <input type="text" id="tecnicoResponsable" placeholder="Ej: Ing. Carlos Ram√≠rez" oninput="autoSave()">
                </div>
                <div class="metadata-field">
                    <label>Ubicaci√≥n</label>
                    <input type="text" id="ubicacionPlanta" placeholder="Ej: √Årea de Filete - L√≠nea 1" oninput="autoSave()">
                </div>
                <div class="metadata-field">
                    <label>Estado General</label>
                    <select id="estadoGeneral" oninput="autoSave()" style="padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 11px; background: white;">
                        <option value="">-- Seleccionar --</option>
                        <option value="operativo">‚úÖ Operativo</option>
                        <option value="mantenimiento">‚ö†Ô∏è Requiere Mantenimiento</option>
                        <option value="detenido">üõë Detenido</option>
                        <option value="critico">‚ùå Estado Cr√≠tico</option>
                    </select>
                </div>
                <div class="metadata-field" style="grid-column: 1 / -1;">
                    <label>Observaciones Generales</label>
                    <textarea id="observacionesGenerales" rows="3" placeholder="Ej: Revisi√≥n programada mensual. Se detectaron desgastes menores en cinta #3..." oninput="autoSave()"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Panel de Personalizaci√≥n de Colores -->
        <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; font-size: 11px;">üé® Color Principal:</label>
                    <input type="color" id="color-primary" value="#5499c7" onchange="updateColors()" style="width: 40px; height: 30px; border: none; cursor: pointer; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; font-size: 11px;">üé® Color √Årea:</label>
                    <input type="color" id="color-area" value="#85929e" onchange="updateColors()" style="width: 40px; height: 30px; border: none; cursor: pointer; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; font-size: 11px;">üé® Color Encabezado:</label>
                    <input type="color" id="color-header" value="#34495e" onchange="updateColors()" style="width: 40px; height: 30px; border: none; cursor: pointer; border-radius: 4px;">
                </div>
                <button class="btn btn-warning" onclick="resetColors()" style="font-size: 10px; padding: 6px 12px;">‚Üª Restaurar colores</button>
            </div>
        </div>
        
        <div class="export-buttons" id="export-buttons">
            <button class="btn btn-primary" onclick="saveAllDataManually()">üíæ Guardar Todo</button>
            <button class="btn btn-success" onclick="exportDataWithImages()" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">üì¶ Exportar Datos+Fotos</button>
            <button class="btn btn-warning" onclick="document.getElementById('import-data-file').click()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">üì• Importar Datos+Fotos</button>
            <input type="file" id="import-data-file" accept=".json" style="display: none;" onchange="importDataWithImages(this).catch(e => console.error(e))">
            <button class="btn btn-pdf" onclick="showPDFOptions()">üìÑ Exportar PDF Pro</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Exportar Excel</button>
            <button class="btn btn-danger" onclick="clearSavedData()">üóëÔ∏è Limpiar Datos</button>
            <select id="pdf-template" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #fff; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-weight: 700; cursor: pointer; font-size: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-right: 8px;">
                <option value="completo" selected style="background: #c0392b; color: white;">üìã PDF Completo</option>
                <option value="ejecutivo" style="background: #c0392b; color: white;">üìä PDF Ejecutivo</option>
                <option value="tecnico" style="background: #c0392b; color: white;">üîß PDF T√©cnico</option>
            </select>
            <select id="pdf-quality" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #fff; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; font-weight: 700; cursor: pointer; font-size: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                <option value="low" style="background: #34495e; color: white;">üìâ Calidad Baja</option>
                <option value="medium" selected style="background: #34495e; color: white;">üìä Calidad Media</option>
                <option value="high" style="background: #34495e; color: white;">üìà Calidad Alta</option>
                <option value="ultra" style="background: #34495e; color: white;">üéØ Calidad Ultra</option>
            </select>
            <select id="pdf-image-size" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #fff; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; font-weight: 700; cursor: pointer; font-size: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                <option value="small" style="background: #34495e; color: white;">üìê Peque√±a (60mm)</option>
                <option value="medium" style="background: #34495e; color: white;">üìê Mediana (85mm)</option>
                <option value="large" selected style="background: #34495e; color: white;">üìê Grande (110mm)</option>
                <option value="xlarge" style="background: #34495e; color: white;">üìê Muy Grande (140mm)</option>
            </select>
        </div>
        <div id="save-status" class="save-status"></div>

        <div id="cintas-container"></div>
        
        <button class="btn btn-add-section" onclick="addNewCintaSection()">‚ûï Agregar Nueva Cinta</button>
    </div>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let projectDirectoryHandle = null;
        let imagesFolderHandle = null;
        let saveTimeout;
        let hasUnsavedChanges = false;
        let cintaCounter = 1;
        let pdfQualitySettings = {
            'low': { scale: 2, quality: 0.70, size: 70 },
            'medium': { scale: 3, quality: 0.85, size: 85 },
            'high': { scale: 4, quality: 0.95, size: 100 },
            'ultra': { scale: 6, quality: 0.98, size: 120 }
        };
        
        // ==================== GESTI√ìN DE CARPETAS Y PERSISTENCIA ====================
        async function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CintasPlantaDB', 2);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('handles')) {
                        db.createObjectStore('handles');
                    }
                    if (!db.objectStoreNames.contains('images')) {
                        db.createObjectStore('images'); // Para guardar im√°genes
                    }
                };
            });
        }
        
        async function saveDirectoryHandle(handle) {
            try {
                const db = await openDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['handles'], 'readwrite');
                    const store = transaction.objectStore('handles');
                    const request = store.put(handle, 'projectDirectory');
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Error guardando handle:', e);
            }
        }
        
        async function loadDirectoryHandle() {
            try {
                const db = await openDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['handles'], 'readonly');
                    const store = transaction.objectStore('handles');
                    const request = store.get('projectDirectory');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            } catch (e) {
                return null;
            }
        }
        
        // ==================== FUNCIONES PARA INDEXEDDB DE IM√ÅGENES ====================
        async function saveImageToIndexedDB(imageId, imageData) {
            try {
                const db = await openDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['images'], 'readwrite');
                    const store = transaction.objectStore('images');
                    const request = store.put(imageData, imageId);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Error guardando imagen en IndexedDB:', e);
                throw e;
            }
        }
        
        async function loadImageFromIndexedDB(imageId) {
            try {
                const db = await openDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['images'], 'readonly');
                    const store = transaction.objectStore('images');
                    const request = store.get(imageId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            } catch (e) {
                console.error('Error cargando imagen de IndexedDB:', e);
                return null;
            }
        }
        
        async function deleteImageFromIndexedDB(imageId) {
            try {
                const db = await openDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['images'], 'readwrite');
                    const store = transaction.objectStore('images');
                    const request = store.delete(imageId);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Error eliminando imagen de IndexedDB:', e);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('file-system-status');
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            const connectBtn = document.getElementById('connect-folder-btn');
            
            if (connected) {
                statusDiv.className = 'status-badge connected';
                statusText.textContent = 'Conectado';
                connectBtn.style.display = 'none';
            } else {
                statusDiv.className = 'status-badge disconnected';
                statusText.textContent = 'Desconectado';
                connectBtn.style.display = 'inline-block';
            }
        }
        
        async function connectFolderManually() {
            const success = await setupProjectDirectory();
            if (success) {
                updateConnectionStatus(true);
                showSaveStatus('‚úÖ Carpeta conectada correctamente', true);
                await syncImagesFromFolder();
            }
        }
        
        async function setupProjectDirectory() {
            try {
                if (!('showDirectoryPicker' in window)) {
                    alert('Tu navegador no soporta esta funci√≥n. Usa Chrome o Edge.');
                    return false;
                }
                
                projectDirectoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                imagesFolderHandle = await projectDirectoryHandle.getDirectoryHandle('imagenes', { create: true });
                await saveDirectoryHandle(projectDirectoryHandle);
                return true;
            } catch (e) {
                console.error('Error:', e);
                return false;
            }
        }
        
        async function syncImagesFromFolder() {
            // Implementaci√≥n similar al original
            console.log('Sincronizando im√°genes...');
        }
        
        function showSaveStatus(message, isSuccess) {
            const status = document.getElementById('save-status');
            status.textContent = message;
            status.className = isSuccess ? 'save-status saved show' : 'save-status show';
            setTimeout(() => status.classList.remove('show'), 3000);
        }
        
        // ==================== GESTI√ìN DIN√ÅMICA DE CINTAS ====================
        function createCintaSection(cintaNum, title = '', area = '') {
            const section = document.createElement('div');
            section.className = 'cinta-section';
            section.setAttribute('data-cinta-id', cintaNum);
            
            section.innerHTML = `
                <input type="text" class="area-field" value="${area}" oninput="autoSave()" placeholder="üìç √ÅREA (Ej: √ÅREA FILETE, √ÅREA EVISCERADO)" data-area-field contenteditable="true">
                <div class="cinta-header">
                    <input type="text" class="cinta-title-editable" value="${title || 'CINTA ' + cintaNum + ' - Nueva Cinta'}" oninput="autoSave()" placeholder="Nombre de la cinta">
                    <div class="cinta-controls">
                        <button class="btn-small btn-move-up" onclick="moveCintaUp(${cintaNum})" title="Mover arriba">‚Üë</button>
                        <button class="btn-small btn-move-down" onclick="moveCintaDown(${cintaNum})" title="Mover abajo">‚Üì</button>
                        <button class="btn-small btn-delete-section" onclick="deleteCintaSection(${cintaNum})" title="Eliminar cinta">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="cinta-content">
                    <div class="cinta-data">
                        <div class="section-subtitle">
                            <span contenteditable="true" oninput="autoSave()" style="cursor: text; outline: none;">üìã ESPECIFICACIONES DE BANDA</span>
                            <div>
                                <button class="btn-small btn-add-row" onclick="addTableRow(${cintaNum}, 'banda')" style="background: #5499c7; color: white;">+ Fila</button>
                                <button class="btn-small btn-add-col" onclick="addTableColumn(${cintaNum}, 'banda')" style="background: #5499c7; color: white;">+ Columna</button>
                            </div>
                        </div>
                        <table class="table-banda" data-table-id="banda-${cintaNum}">
                            <thead>
                                <tr>
                                    <th style="width: 25%">Campo</th>
                                    <th style="width: 75%">Valor
                                        <span class="col-controls">
                                            <button class="btn-col btn-add-col" onclick="addColumnAfter(this)" title="Insertar columna">+</button>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Tipo de banda</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: Serie 1100 Flush Grid"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Material</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: Polipropileno Blanco"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Ancho</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: 304 mm"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Largo</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: 5.5 metros"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Varillas</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: Acetal Blanco"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Proveedor</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Nombre del proveedor"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="section-subtitle">
                            <span contenteditable="true" oninput="autoSave()" style="cursor: text; outline: none;">‚öôÔ∏è MOTORREDUCTOR</span>
                            <div>
                                <button class="btn-small" onclick="copyMotorData(${cintaNum})" style="background: #9b59b6; color: white;" title="Copiar datos de otro motor">üìã Copiar Motor</button>
                                <button class="btn-small btn-add-row" onclick="addTableRow(${cintaNum}, 'motor')" style="background: #5499c7; color: white;">+ Fila</button>
                                <button class="btn-small btn-add-col" onclick="addTableColumn(${cintaNum}, 'motor')" style="background: #5499c7; color: white;">+ Columna</button>
                            </div>
                        </div>
                        <table class="table-motor" data-table-id="motor-${cintaNum}">
                            <thead>
                                <tr>
                                    <th style="width: 25%">Campo</th>
                                    <th style="width: 75%">Valor
                                        <span class="col-controls">
                                            <button class="btn-col btn-add-col" onclick="addColumnAfter(this)" title="Insertar columna">+</button>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Marca / Modelo</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: SEW Eurodrive"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Potencia</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: 1.5 HP / 1.1 kW"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Voltaje</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: 220/380V - 60Hz"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">RPM Motor / Salida</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: 1720 RPM / 43 RPM"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">Corriente nominal</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Ej: 3.2 / 1.85 A"></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-col" contenteditable="true" oninput="autoSave()">N√∫mero de serie</td>
                                    <td class="value-col">
                                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder=""></textarea>
                                        <div class="row-controls">
                                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="multimedia-section">
                        <div class="multimedia-title">üì∏ FOTOS - BANDA Y SPROCKETS</div>
                        <button class="add-photo-btn" onclick="addPhoto('grid-${cintaNum}-banda')">üì∑ Agregar Foto</button>
                        <input type="file" id="file-${cintaNum}-banda" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this, 'grid-${cintaNum}-banda')" multiple />
                        <div class="image-grid" id="grid-${cintaNum}-banda"></div>
                        
                        <div class="multimedia-title" style="margin-top: 15px;">üì∏ FOTOS - MOTORREDUCTOR</div>
                        <button class="add-photo-btn" onclick="addPhoto('grid-${cintaNum}-motor')">üì∑ Agregar Foto</button>
                        <input type="file" id="file-${cintaNum}-motor" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this, 'grid-${cintaNum}-motor')" multiple />
                        <div class="image-grid" id="grid-${cintaNum}-motor"></div>
                    </div>
                </div>
            `;
            
            return section;
        }
        
        function addNewCintaSection() {
            cintaCounter++;
            const container = document.getElementById('cintas-container');
            const section = createCintaSection(cintaCounter);
            container.appendChild(section);
            autoSave();
            showSaveStatus('‚úÖ Nueva cinta agregada', true);
        }
        
        function deleteCintaSection(cintaNum) {
            if (confirm('¬øEliminar esta cinta y todas sus im√°genes?')) {
                const section = document.querySelector(`[data-cinta-id="${cintaNum}"]`);
                if (section) {
                    section.remove();
                    autoSave();
                    showSaveStatus('‚úÖ Cinta eliminada', true);
                }
            }
        }
        
        function moveCintaUp(cintaNum) {
            const section = document.querySelector(`[data-cinta-id="${cintaNum}"]`);
            if (section && section.previousElementSibling) {
                section.parentNode.insertBefore(section, section.previousElementSibling);
                autoSave();
            }
        }
        
        function moveCintaDown(cintaNum) {
            const section = document.querySelector(`[data-cinta-id="${cintaNum}"]`);
            if (section && section.nextElementSibling) {
                section.parentNode.insertBefore(section.nextElementSibling, section);
                autoSave();
            }
        }
        
        // ==================== COPIAR DATOS DE MOTOR ====================
        function copyMotorData(targetCintaNum) {
            // Obtener lista de todas las cintas
            const allSections = document.querySelectorAll('.cinta-section');
            if (allSections.length < 2) {
                alert('No hay otros motores para copiar. Necesitas al menos 2 cintas.');
                return;
            }
            
            // Crear lista de opciones
            let options = 'Selecciona el motor a copiar:\n\n';
            const cintaList = [];
            allSections.forEach((section, index) => {
                const cintaId = section.getAttribute('data-cinta-id');
                if (cintaId !== String(targetCintaNum)) {
                    const title = section.querySelector('.cinta-title-editable').value;
                    cintaList.push({ id: cintaId, title: title, index: index + 1 });
                    options += `${index + 1}. ${title}\n`;
                }
            });
            
            const selection = prompt(options + '\nIngresa el n√∫mero:');
            if (!selection) return;
            
            const selectedIndex = parseInt(selection) - 1;
            if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= allSections.length) {
                alert('Selecci√≥n inv√°lida');
                return;
            }
            
            const sourceCintaId = allSections[selectedIndex].getAttribute('data-cinta-id');
            
            // Obtener datos de la tabla motor origen
            const sourceTable = document.querySelector(`[data-table-id="motor-${sourceCintaId}"]`);
            const targetTable = document.querySelector(`[data-table-id="motor-${targetCintaNum}"]`);
            
            if (!sourceTable || !targetTable) {
                alert('Error al encontrar las tablas');
                return;
            }
            
            // Copiar estructura de encabezados
            const sourceHeaders = sourceTable.querySelectorAll('thead th');
            const targetThead = targetTable.querySelector('thead tr');
            targetThead.innerHTML = '';
            sourceHeaders.forEach((th, index) => {
                const newTh = document.createElement('th');
                if (index === 0) {
                    newTh.style.width = '25%';
                    newTh.textContent = th.textContent.trim();
                } else {
                    newTh.innerHTML = th.innerHTML;
                }
                targetThead.appendChild(newTh);
            });
            
            // Copiar filas
            const sourceRows = sourceTable.querySelectorAll('tbody tr');
            const targetTbody = targetTable.querySelector('tbody');
            targetTbody.innerHTML = '';
            
            sourceRows.forEach(row => {
                const newRow = document.createElement('tr');
                const label = row.querySelector('.label-col').textContent;
                const values = Array.from(row.querySelectorAll('.editable-field')).map(field => field.value);
                
                let rowHTML = `<td class="label-col" contenteditable="true" oninput="autoSave()">${label}</td>`;
                values.forEach((value, index) => {
                    rowHTML += `
                        <td class="value-col">
                            <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();">${value}</textarea>
                            ${index === 0 ? `<div class="row-controls">
                                <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                                <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                            </div>` : ''}
                        </td>
                    `;
                });
                
                newRow.innerHTML = rowHTML;
                targetTbody.appendChild(newRow);
                newRow.querySelectorAll('.editable-field').forEach(autoExpandTextarea);
            });
            
            autoSave();
            showSaveStatus('‚úÖ Datos de motor copiados correctamente', true);
        }
        
        // ==================== GESTI√ìN DIN√ÅMICA DE FILAS ====================
        function addTableRow(cintaNum, tableType) {
            const table = document.querySelector(`[data-table-id="${tableType}-${cintaNum}"] tbody`);
            const firstRow = table.querySelector('tr');
            const colCount = firstRow ? firstRow.cells.length : 2;
            
            const newRow = document.createElement('tr');
            let rowHTML = '<td class="label-col" contenteditable="true" oninput="autoSave()">Nuevo campo</td>';
            
            for (let i = 1; i < colCount; i++) {
                rowHTML += `
                    <td class="value-col">
                        <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Valor"></textarea>
                        ${i === 1 ? `<div class="row-controls">
                            <button class="btn-row btn-add-row" onclick="insertRowAfter(this)" title="Insertar fila">+</button>
                            <button class="btn-row btn-delete-row" onclick="deleteRow(this)" title="Eliminar fila">√ó</button>
                        </div>` : ''}
                    </td>
                `;
            }
            
            newRow.innerHTML = rowHTML;
            table.appendChild(newRow);
            autoSave();
        }
        
        function insertRowAfter(button) {
            const currentRow = button.closest('tr');
            const newRow = currentRow.cloneNode(true);
            newRow.querySelectorAll('.editable-field').forEach(field => field.value = '');
            currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
            autoSave();
        }
        
        function deleteRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                autoSave();
            } else {
                alert('No puedes eliminar la √∫ltima fila de la tabla');
            }
        }
        
        // ==================== GESTI√ìN DIN√ÅMICA DE COLUMNAS ====================
        function addTableColumn(cintaNum, tableType) {
            const table = document.querySelector(`[data-table-id="${tableType}-${cintaNum}"]`);
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            // Contar columnas actuales
            const currentColCount = thead.cells.length;
            const newColNum = currentColCount;
            
            // Calcular ancho proporcional para todas las columnas de valor
            const labelWidth = 25; // 25% para etiquetas
            const valueWidth = (100 - labelWidth) / currentColCount; // Dividir resto entre valores
            
            // Ajustar ancho de todas las columnas de valor existentes
            for (let i = 1; i < thead.cells.length; i++) {
                thead.cells[i].style.width = valueWidth + '%';
            }
            
            // Agregar encabezado de columna
            const newHeader = document.createElement('th');
            newHeader.style.width = valueWidth + '%';
            newHeader.innerHTML = `Valor ${newColNum}
                <span class="col-controls">
                    <button class="btn-col btn-add-col" onclick="addColumnAfter(this)" title="Insertar columna">+</button>
                    <button class="btn-col btn-delete-col" onclick="deleteColumn(this)" title="Eliminar columna">√ó</button>
                </span>`;
            thead.appendChild(newHeader);
            
            // Actualizar controles de columnas existentes
            const existingHeaders = thead.querySelectorAll('th:not(:first-child)');
            existingHeaders.forEach((th, index) => {
                if (index < existingHeaders.length - 1) {
                    const controls = th.querySelector('.col-controls');
                    if (controls && !controls.querySelector('.btn-delete-col')) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn-col btn-delete-col';
                        deleteBtn.onclick = function() { deleteColumn(this); };
                        deleteBtn.title = 'Eliminar columna';
                        deleteBtn.textContent = '√ó';
                        controls.appendChild(deleteBtn);
                    }
                }
            });
            
            // Agregar celdas en cada fila del tbody
            tbody.querySelectorAll('tr').forEach(row => {
                const newCell = document.createElement('td');
                newCell.className = 'value-col';
                newCell.innerHTML = '<textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Valor"></textarea>';
                row.appendChild(newCell);
            });
            
            autoSave();
        }
        
        function addColumnAfter(button) {
            const th = button.closest('th');
            const table = th.closest('table');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            const colIndex = Array.from(thead.cells).indexOf(th);
            
            if (colIndex === 0) return; // No insertar despu√©s de la columna de etiquetas
            
            const currentColCount = thead.cells.length;
            
            // Calcular ancho proporcional para todas las columnas de valor
            const labelWidth = 25; // 25% para etiquetas
            const valueWidth = (100 - labelWidth) / currentColCount; // Nueva distribuci√≥n
            
            // Ajustar ancho de todas las columnas de valor existentes
            for (let i = 1; i < thead.cells.length; i++) {
                thead.cells[i].style.width = valueWidth + '%';
            }
            
            // Insertar encabezado
            const newHeader = document.createElement('th');
            newHeader.style.width = valueWidth + '%';
            newHeader.innerHTML = `Valor ${currentColCount}
                <span class="col-controls">
                    <button class="btn-col btn-add-col" onclick="addColumnAfter(this)" title="Insertar columna">+</button>
                    <button class="btn-col btn-delete-col" onclick="deleteColumn(this)" title="Eliminar columna">√ó</button>
                </span>`;
            th.parentNode.insertBefore(newHeader, th.nextSibling);
            
            // Actualizar controles de la columna actual si no tiene bot√≥n de eliminar
            const controls = th.querySelector('.col-controls');
            if (controls && !controls.querySelector('.btn-delete-col')) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-col btn-delete-col';
                deleteBtn.onclick = function() { deleteColumn(this); };
                deleteBtn.title = 'Eliminar columna';
                deleteBtn.textContent = '√ó';
                controls.appendChild(deleteBtn);
            }
            
            // Insertar celdas en cada fila
            tbody.querySelectorAll('tr').forEach(row => {
                const newCell = document.createElement('td');
                newCell.className = 'value-col';
                newCell.innerHTML = '<textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();" placeholder="Valor"></textarea>';
                const currentCell = row.cells[colIndex];
                row.insertBefore(newCell, currentCell.nextSibling);
            });
            
            autoSave();
        }
        
        function deleteColumn(button) {
            const th = button.closest('th');
            const table = th.closest('table');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            const colIndex = Array.from(thead.cells).indexOf(th);
            
            // No eliminar si solo hay 2 columnas (etiqueta + 1 valor)
            if (thead.cells.length <= 2) {
                alert('Debe haber al menos una columna de valores');
                return;
            }
            
            // Eliminar encabezado
            th.remove();
            
            // Eliminar celdas correspondientes
            tbody.querySelectorAll('tr').forEach(row => {
                if (row.cells[colIndex]) {
                    row.cells[colIndex].remove();
                }
            });
            
            // Recalcular y aplicar proporcionalidad
            const currentColCount = thead.cells.length;
            const labelWidth = 25; // 25% para etiquetas
            const valueWidth = (100 - labelWidth) / (currentColCount - 1);
            
            // Ajustar ancho de todas las columnas de valor restantes
            for (let i = 1; i < thead.cells.length; i++) {
                thead.cells[i].style.width = valueWidth + '%';
            }
            
            // Renumerar columnas restantes
            thead.querySelectorAll('th:not(:first-child)').forEach((header, index) => {
                const text = header.childNodes[0];
                if (text.textContent.includes('Valor')) {
                    text.textContent = `Valor ${index + 1}\n                `;
                }
            });
            
            autoSave();
        }
        
        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        
        // ==================== GESTI√ìN DE IM√ÅGENES ====================
        function addPhoto(gridId) {
            const fileId = gridId.replace('grid-', 'file-');
            document.getElementById(fileId).click();
        }
        
        async function handlePhotoUpload(input, gridId) {
            if (!input.files) return;
            
            // Procesar cada archivo y guardar en IndexedDB + base64 para persistencia
            for (const file of input.files) {
                try {
                    // Generar ID √∫nico para la imagen
                    const timestamp = Date.now();
                    const randomStr = Math.random().toString(36).substring(2, 8);
                    const imageId = `img_${timestamp}_${randomStr}`;
                    
                    // Leer archivo como base64 para persistencia garantizada
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const base64Data = e.target.result;
                        
                        // Guardar en IndexedDB con base64
                        await saveImageToIndexedDB(imageId, {
                            data: base64Data,
                            type: file.type,
                            name: file.name,
                            size: file.size
                        });
                        
                        console.log(`‚úÖ Imagen guardada: ${imageId} (${(file.size/1024).toFixed(2)} KB)`);
                        
                        // Agregar imagen al grid
                        await addImageToGrid(imageId, gridId, imageId);
                        setTimeout(() => autoSave(), 500);
                    };
                    reader.readAsDataURL(file);
                    
                } catch (e) {
                    console.error('Error guardando imagen:', e);
                    alert(`Error al guardar ${file.name}`);
                }
            }
            
            input.value = '';
        }
        
        async function addImageToGrid(imageId, gridId, filepath) {
            const grid = document.getElementById(gridId);
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.setAttribute('data-rotation', '0');
            imageItem.setAttribute('data-scale', '1');
            imageItem.setAttribute('data-filepath', imageId); // Guardar ID en lugar de filepath
            imageItem.setAttribute('draggable', 'true');
            
            const img = document.createElement('img');
            
            // Configurar onload ANTES de asignar src - FORZAR dimensiones
            img.onload = function() {
                // Esperar a que la imagen est√© completamente cargada
                setTimeout(() => {
                    // Preservar proporciones originales, limitar tama√±o m√°ximo
                    const maxWidth = 400;
                    const maxHeight = 300;
                    let width = img.naturalWidth || img.width;
                    let height = img.naturalHeight || img.height;
                    
                    // Evitar divisi√≥n por cero
                    if (width === 0 || height === 0) {
                        width = 200;
                        height = 150;
                    }
                    
                    // Calcular escala para ajustar sin deformar
                    const scale = Math.min(maxWidth / width, maxHeight / height, 1);
                    
                    // FORZAR las dimensiones en el contenedor
                    imageItem.style.width = (width * scale) + 'px';
                    imageItem.style.height = (height * scale) + 'px';
                    imageItem.style.display = 'inline-block';
                }, 10);
            };
            
            // Cargar imagen desde IndexedDB
            try {
                const imageData = await loadImageFromIndexedDB(imageId);
                if (imageData) {
                    // Si ya est√° en base64 con prefijo data:, usar directamente
                    if (typeof imageData.data === 'string' && imageData.data.startsWith('data:')) {
                        img.src = imageData.data;
                        console.log(`‚úÖ Imagen cargada (base64 completo): ${imageId} (${(imageData.size/1024).toFixed(2)} KB)`);
                    } 
                    // Si es base64 puro sin prefijo, agregar el prefijo
                    else if (typeof imageData.data === 'string' && !imageData.data.startsWith('data:')) {
                        const mimeType = imageData.type || 'image/jpeg';
                        img.src = `data:${mimeType};base64,${imageData.data}`;
                        console.log(`‚úÖ Imagen cargada (base64 sin prefijo): ${imageId} (${(imageData.size/1024).toFixed(2)} KB)`);
                    }
                    // Si es ArrayBuffer, convertir a blob
                    else if (imageData.data instanceof ArrayBuffer) {
                        const blob = new Blob([imageData.data], { type: imageData.type || 'image/jpeg' });
                        const imageUrl = URL.createObjectURL(blob);
                        img.src = imageUrl;
                        console.log(`‚úÖ Imagen cargada (blob): ${imageId} (${(imageData.size/1024).toFixed(2)} KB)`);
                    } else {
                        console.error('‚ùå Formato de data desconocido:', typeof imageData.data);
                        img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="150"%3E%3Crect fill="%23f00" width="200" height="150"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23fff" font-size="12"%3EFormato inv√°lido%3C/text%3E%3C/svg%3E';
                    }
                } else {
                    console.error('‚ùå Imagen no encontrada en IndexedDB:', imageId);
                    img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="150"%3E%3Crect fill="%23ddd" width="200" height="150"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23999" font-size="14"%3EImagen no encontrada%3C/text%3E%3C/svg%3E';
                }
            } catch (e) {
                console.error('‚ùå Error cargando imagen:', e);
                img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="150"%3E%3Crect fill="%23f00" width="200" height="150"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23fff" font-size="12"%3EError: ' + e.message + '%3C/text%3E%3C/svg%3E';
            }
            
            imageItem.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY < 0 ? 0.1 : -0.1;
                zoomImage(imageItem, delta);
            }, { passive: false });
            
            const controls = `
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomImage(this.closest('.image-item'), -0.1)">‚àí</button>
                    <button class="zoom-btn" onclick="zoomImage(this.closest('.image-item'), 0.1)">+</button>
                </div>
                <button class="rotate-btn" onclick="rotateImage(this.closest('.image-item'))">‚Üª</button>
                <button class="delete-btn" onclick="deleteImage(this.closest('.image-item'))">√ó</button>
                <div class="annotation-tools">
                    <button class="annotation-tool-btn" onclick="setAnnotationTool(this, 'arrow')" title="Flecha">‚û§</button>
                    <button class="annotation-tool-btn" onclick="setAnnotationTool(this, 'circle')" title="C√≠rculo">‚≠ï</button>
                    <button class="annotation-tool-btn" onclick="setAnnotationTool(this, 'rect')" title="Rect√°ngulo">‚ñ≠</button>
                    <button class="annotation-tool-btn" onclick="setAnnotationTool(this, 'free')" title="Dibujo libre">‚úèÔ∏è</button>
                    <button class="annotation-tool-btn" onclick="setAnnotationTool(this, 'text')" title="Texto">T</button>
                    <input type="color" class="color-picker-mini" value="#ff0000" onchange="setAnnotationColor(this)" title="Color">
                    <button class="annotation-tool-btn" onclick="undoLastAnnotation(this.closest('.image-item'))" title="Deshacer" style="background: rgba(243, 156, 18, 0.8);">‚Ü∂</button>
                    <button class="annotation-tool-btn" onclick="clearAnnotations(this.closest('.image-item'))" title="Borrar todo" style="background: rgba(231, 76, 60, 0.8);">üóëÔ∏è</button>
                </div>
            `;
            
            imageItem.innerHTML = controls;
            imageItem.appendChild(img);
            
            // Crear canvas de anotaciones
            const canvas = document.createElement('canvas');
            canvas.className = 'annotation-canvas disabled';
            canvas.setAttribute('data-image-id', imageId);
            imageItem.appendChild(canvas);
            
            // Inicializar canvas cuando la imagen cargue
            img.addEventListener('load', () => {
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.style.width = img.width + 'px';
                canvas.style.height = img.height + 'px';
                
                // Cargar anotaciones guardadas si existen
                loadAnnotations(imageId, canvas);
            });
            
            // Agregar campo de descripci√≥n
            const descContainer = document.createElement('div');
            descContainer.className = 'image-description-container';
            descContainer.innerHTML = `
                <input type="text" 
                       class="image-description" 
                       placeholder="üìù Descripci√≥n (ej: Vista frontal, Placa motor...)" 
                       oninput="autoSave()"
                       data-image-id="${imageId}">
            `;
            imageItem.appendChild(descContainer);
            
            // Verificar que el grid existe antes de agregar
            if (grid) {
                grid.appendChild(imageItem);
                
                // FORZAR dimensiones inmediatamente si la imagen ya est√° cargada
                if (img.complete && img.naturalWidth > 0) {
                    const maxWidth = 400;
                    const maxHeight = 300;
                    let width = img.naturalWidth;
                    let height = img.naturalHeight;
                    const scale = Math.min(maxWidth / width, maxHeight / height, 1);
                    imageItem.style.width = (width * scale) + 'px';
                    imageItem.style.height = (height * scale) + 'px';
                    imageItem.style.display = 'inline-block';
                }
                
                autoSave();
            } else {
                console.error(`Grid no encontrado: ${gridId}`);
            }
        }
        
        function zoomImage(imageItem, delta) {
            const img = imageItem.querySelector('img');
            let scale = parseFloat(imageItem.getAttribute('data-scale')) || 1;
            scale = Math.max(0.1, Math.min(3, scale + delta));
            imageItem.setAttribute('data-scale', scale);
            
            // Mantener proporci√≥n de aspecto
            const width = img.naturalWidth * scale;
            const height = img.naturalHeight * scale;
            imageItem.style.width = width + 'px';
            imageItem.style.height = height + 'px';
            autoSave();
        }
        
        function rotateImage(imageItem) {
            const img = imageItem.querySelector('img');
            let rotation = parseInt(imageItem.getAttribute('data-rotation')) || 0;
            rotation = (rotation + 90) % 360;
            imageItem.setAttribute('data-rotation', rotation);
            img.style.transform = `rotate(${rotation}deg)`;
            
            // Intercambiar width/height cuando la rotaci√≥n es 90¬∞ o 270¬∞
            if (rotation === 90 || rotation === 270) {
                // Obtener dimensiones originales (antes de la rotaci√≥n)
                const currentWidth = parseFloat(imageItem.style.width);
                const currentHeight = parseFloat(imageItem.style.height);
                
                // Intercambiar dimensiones
                imageItem.style.width = currentHeight + 'px';
                imageItem.style.height = currentWidth + 'px';
            } else if (rotation === 0 || rotation === 180) {
                // Restaurar proporciones originales
                const scale = parseFloat(imageItem.getAttribute('data-scale')) || 1;
                const maxWidth = 400;
                const maxHeight = 300;
                let width = img.naturalWidth || 200;
                let height = img.naturalHeight || 150;
                const scaleRatio = Math.min(maxWidth / width, maxHeight / height, 1);
                imageItem.style.width = (width * scaleRatio * scale) + 'px';
                imageItem.style.height = (height * scaleRatio * scale) + 'px';
            }
            
            autoSave();
        }
        
        async function deleteImage(imageItem) {
            if (confirm('¬øEliminar esta imagen?')) {
                // Obtener ID de la imagen para eliminar de IndexedDB
                const imageId = imageItem.getAttribute('data-filepath');
                if (imageId) {
                    await deleteImageFromIndexedDB(imageId);
                    console.log(`üóëÔ∏è Imagen eliminada de IndexedDB: ${imageId}`);
                }
                imageItem.remove();
                autoSave();
            }
        }
        
        // ==================== ANOTACIONES EN IM√ÅGENES ====================
        let currentAnnotationTool = null;
        let annotationColor = '#ff0000';
        let isDrawing = false;
        let startX, startY;
        let annotations = {}; // Almacenar anotaciones por imageId
        
        function setAnnotationTool(btn, tool) {
            const imageItem = btn.closest('.image-item');
            const canvas = imageItem.querySelector('.annotation-canvas');
            const allBtns = imageItem.querySelectorAll('.annotation-tool-btn');
            
            // Toggle tool
            if (currentAnnotationTool === tool) {
                currentAnnotationTool = null;
                allBtns.forEach(b => b.classList.remove('active'));
                canvas.classList.add('disabled');
            } else {
                currentAnnotationTool = tool;
                allBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                canvas.classList.remove('disabled');
                
                // Configurar eventos del canvas
                setupCanvasEvents(canvas, imageItem);
            }
        }
        
        function setAnnotationColor(input) {
            annotationColor = input.value;
        }
        
        function setupCanvasEvents(canvas, imageItem) {
            const ctx = canvas.getContext('2d');
            const imageId = canvas.getAttribute('data-image-id');
            
            // Redibujar anotaciones existentes
            if (annotations[imageId]) {
                redrawAnnotations(imageId, canvas);
            }
            
            // Prevenir el comportamiento predeterminado que causa el arrastre
            canvas.addEventListener('dragstart', (e) => e.preventDefault());
            
            canvas.addEventListener('mousedown', (e) => {
                if (!currentAnnotationTool) return;
                e.preventDefault(); // Prevenir arrastre de imagen
                e.stopPropagation();
                
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                
                if (currentAnnotationTool === 'text') {
                    const text = prompt('Ingresa el texto:');
                    if (text) {
                        ctx.font = '16px Arial';
                        ctx.fillStyle = annotationColor;
                        ctx.fillText(text, startX, startY);
                        
                        // Guardar anotaci√≥n
                        saveAnnotation(imageId, {
                            type: 'text',
                            x: startX,
                            y: startY,
                            text: text,
                            color: annotationColor
                        });
                    }
                    isDrawing = false;
                    currentAnnotationTool = null; // Desactivar despu√©s de agregar texto
                    imageItem.querySelectorAll('.annotation-tool-btn').forEach(b => b.classList.remove('active'));
                    canvas.classList.add('disabled');
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing || !currentAnnotationTool || currentAnnotationTool === 'text') return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                if (currentAnnotationTool === 'free') {
                    ctx.strokeStyle = annotationColor;
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();
                    startX = currentX;
                    startY = currentY;
                }
            });
            
            canvas.addEventListener('mouseup', (e) => {
                if (!isDrawing || !currentAnnotationTool || currentAnnotationTool === 'text') return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                
                ctx.strokeStyle = annotationColor;
                ctx.lineWidth = 3;
                ctx.fillStyle = 'transparent';
                
                if (currentAnnotationTool === 'arrow') {
                    drawArrow(ctx, startX, startY, endX, endY, annotationColor);
                    saveAnnotation(imageId, {
                        type: 'arrow',
                        x1: startX,
                        y1: startY,
                        x2: endX,
                        y2: endY,
                        color: annotationColor
                    });
                } else if (currentAnnotationTool === 'circle') {
                    const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    ctx.beginPath();
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    saveAnnotation(imageId, {
                        type: 'circle',
                        x: startX,
                        y: startY,
                        radius: radius,
                        color: annotationColor
                    });
                } else if (currentAnnotationTool === 'rect') {
                    ctx.strokeRect(startX, startY, endX - startX, endY - startY);
                    saveAnnotation(imageId, {
                        type: 'rect',
                        x: startX,
                        y: startY,
                        width: endX - startX,
                        height: endY - startY,
                        color: annotationColor
                    });
                } else if (currentAnnotationTool === 'free') {
                    // El free ya se dibuj√≥ en mousemove, solo guardar el final
                    saveAnnotation(imageId, {
                        type: 'free',
                        points: [] // Las l√≠neas libres ya est√°n en el canvas
                    });
                }
                
                isDrawing = false;
            });
        }
        
        function drawArrow(ctx, x1, y1, x2, y2, color) {
            const headlen = 15;
            const angle = Math.atan2(y2 - y1, x2 - x1);
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 3;
            
            // L√≠nea
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            
            // Cabeza de flecha
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
        }
        
        function saveAnnotation(imageId, annotation) {
            if (!annotations[imageId]) {
                annotations[imageId] = [];
            }
            annotations[imageId].push(annotation);
            autoSave();
        }
        
        function redrawAnnotations(imageId, canvas) {
            if (!annotations[imageId]) return;
            
            const ctx = canvas.getContext('2d');
            annotations[imageId].forEach(ann => {
                ctx.strokeStyle = ann.color;
                ctx.fillStyle = ann.color;
                ctx.lineWidth = 3;
                
                if (ann.type === 'arrow') {
                    drawArrow(ctx, ann.x1, ann.y1, ann.x2, ann.y2, ann.color);
                } else if (ann.type === 'circle') {
                    ctx.beginPath();
                    ctx.arc(ann.x, ann.y, ann.radius, 0, 2 * Math.PI);
                    ctx.stroke();
                } else if (ann.type === 'rect') {
                    ctx.strokeRect(ann.x, ann.y, ann.width, ann.height);
                } else if (ann.type === 'text') {
                    ctx.font = '16px Arial';
                    ctx.fillText(ann.text, ann.x, ann.y);
                }
            });
        }
        
        function undoLastAnnotation(imageItem) {
            const canvas = imageItem.querySelector('.annotation-canvas');
            const imageId = canvas.getAttribute('data-image-id');
            
            if (annotations[imageId] && annotations[imageId].length > 0) {
                // Eliminar √∫ltima anotaci√≥n
                annotations[imageId].pop();
                
                // Limpiar canvas y redibujar
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Redibujar anotaciones restantes
                if (annotations[imageId].length > 0) {
                    redrawAnnotations(imageId, canvas);
                } else {
                    delete annotations[imageId];
                }
                
                autoSave();
            }
        }
        
        function clearAnnotations(imageItem) {
            if (confirm('¬øBorrar todas las anotaciones de esta imagen?')) {
                const canvas = imageItem.querySelector('.annotation-canvas');
                const imageId = canvas.getAttribute('data-image-id');
                const ctx = canvas.getContext('2d');
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                annotations[imageId] = [];
                autoSave();
            }
        }
        
        async function loadAnnotations(imageId, canvas) {
            // Las anotaciones se cargan desde el objeto global annotations
            // que se restaura al cargar los datos guardados
            if (annotations[imageId]) {
                redrawAnnotations(imageId, canvas);
            }
        }
        
        // ==================== LOGO Y ENCABEZADO ====================
        let companyLogo = null;
        
        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tama√±o (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('El logo es muy grande. M√°ximo 2MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                companyLogo = e.target.result;
                document.getElementById('logoPreview').src = companyLogo;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
                
                // Guardar logo en IndexedDB
                try {
                    const db = await openDatabase();
                    const tx = db.transaction(['images'], 'readwrite');
                    const store = tx.objectStore('images');
                    await store.put({ id: 'company_logo', base64: companyLogo });
                    console.log('‚úÖ Logo guardado en IndexedDB');
                } catch (err) {
                    console.error('Error guardando logo:', err);
                }
                
                autoSave();
            };
            reader.readAsDataURL(file);
        }
        
        // ==================== GUARDAR Y CARGAR DATOS ====================
        function autoSave() {
            clearTimeout(saveTimeout);
            hasUnsavedChanges = true;
            const status = document.getElementById('save-status');
            status.textContent = 'üíæ Guardando...';
            status.className = 'save-status show';
            
            saveTimeout = setTimeout(function() {
                saveAllData();
                hasUnsavedChanges = false;
                status.textContent = '‚úì Guardado';
                status.className = 'save-status saved show';
                setTimeout(() => status.classList.remove('show'), 1500);
            }, 1000);
        }
        
        function saveAllData() {
            const data = { cintas: [], timestamp: new Date().toISOString() };
            
            // Guardar anotaciones
            data.annotations = annotations;
            
            // Guardar metadatos y encabezado
            data.metadata = {
                fechaInspeccion: document.getElementById('fechaInspeccion').value,
                tecnicoResponsable: document.getElementById('tecnicoResponsable').value,
                ubicacionPlanta: document.getElementById('ubicacionPlanta').value,
                estadoGeneral: document.getElementById('estadoGeneral').value,
                observacionesGenerales: document.getElementById('observacionesGenerales').value
            };
            
            data.header = {
                empresaNombre: document.getElementById('empresaNombre').value,
                plantaNombre: document.getElementById('plantaNombre').value,
                contactoInfo: document.getElementById('contactoInfo').value,
                emailInfo: document.getElementById('emailInfo').value,
                hasLogo: companyLogo ? true : false
            };
            
            document.querySelectorAll('.cinta-section').forEach((section, index) => {
                const cintaData = {
                    id: section.getAttribute('data-cinta-id'),
                    area: section.querySelector('.area-field').value,
                    titulo: section.querySelector('.cinta-title-editable').value,
                    tablas: [],
                    imagenes: {}
                };
                
                // Guardar tablas con soporte multi-columna
                section.querySelectorAll('table').forEach(table => {
                    const tableData = { 
                        tipo: table.getAttribute('data-table-id'), 
                        headers: [],
                        filas: [] 
                    };
                    
                    // Guardar encabezados
                    table.querySelectorAll('thead th').forEach(th => {
                        const headerText = th.childNodes[0] ? th.childNodes[0].textContent.trim() : th.textContent.trim();
                        tableData.headers.push(headerText);
                    });
                    
                    // Guardar filas
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = { label: row.querySelector('.label-col').textContent, valores: [] };
                        row.querySelectorAll('.editable-field').forEach(field => {
                            rowData.valores.push(field.value);
                        });
                        tableData.filas.push(rowData);
                    });
                    cintaData.tablas.push(tableData);
                });
                
                // Guardar im√°genes (solo rutas, NO base64)
                ['banda', 'motor'].forEach(tipo => {
                    const grid = section.querySelector(`#grid-${cintaData.id}-${tipo}`);
                    if (grid) {
                        cintaData.imagenes[tipo] = Array.from(grid.querySelectorAll('.image-item')).map(item => {
                            const descInput = item.querySelector('.image-description');
                            return {
                                filepath: item.getAttribute('data-filepath'), // Solo la ruta
                                rotation: item.getAttribute('data-rotation'),
                                scale: item.getAttribute('data-scale'),
                                width: item.style.width,
                                height: item.style.height,
                                description: descInput ? descInput.value : '' // Guardar descripci√≥n
                            };
                        });
                    }
                });
                
                data.cintas.push(cintaData);
            });
            
            try {
                const dataString = JSON.stringify(data);
                const sizeKB = Math.round(dataString.length / 1024);
                localStorage.setItem('cintasPlantaDataMejorado', dataString);
                console.log('‚úÖ Datos guardados:', data.cintas.length, 'cintas -', sizeKB, 'KB');
            } catch (e) {
                console.error('Error al guardar:', e);
                if (e.name === 'QuotaExceededError') {
                    const dataSize = Math.round(JSON.stringify(data).length / 1024);
                    alert(`‚ö†Ô∏è Almacenamiento localStorage lleno (l√≠mite ~5-10MB)\n\n` +
                          `Tama√±o actual: ${dataSize} KB\n\n` +
                          `‚úÖ Las im√°genes YA est√°n en IndexedDB (sin l√≠mite)\n` +
                          `‚úÖ El logo de empresa est√° en IndexedDB\n\n` +
                          `Soluciones:\n` +
                          `1. Exportar datos completos (backup)\n` +
                          `2. Eliminar cintas antiguas\n` +
                          `3. Acortar observaciones muy largas\n\n` +
                          `Nota: Solo los TEXTOS usan localStorage`);
                } else {
                    alert('Error al guardar datos: ' + e.message);
                }
            }
        }
        
        function saveAllDataManually() {
            saveAllData();
            showSaveStatus('‚úÖ Datos guardados correctamente', true);
        }
        
        function clearSavedData() {
            if (confirm('¬øEliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('cintasPlantaDataMejorado');
                location.reload();
            }
        }
        
        // ==================== PERSONALIZACI√ìN DE COLORES ====================
        function updateColors() {
            const primaryColor = document.getElementById('color-primary').value;
            const areaColor = document.getElementById('color-area').value;
            const headerColor = document.getElementById('color-header').value;
            
            // Actualizar variables CSS
            document.documentElement.style.setProperty('--color-primary', primaryColor);
            document.documentElement.style.setProperty('--color-area', areaColor);
            document.documentElement.style.setProperty('--color-header', headerColor);
            
            // Actualizar elementos din√°micamente
            document.querySelectorAll('.area-field').forEach(el => {
                el.style.background = `linear-gradient(135deg, ${areaColor} 0%, ${shadeColor(areaColor, -20)} 100%)`;
            });
            
            document.querySelectorAll('.section-subtitle').forEach(el => {
                el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${shadeColor(primaryColor, -20)} 100%)`;
            });
            
            document.querySelector('.export-buttons').style.background = `linear-gradient(135deg, ${headerColor} 0%, ${shadeColor(headerColor, -20)} 100%)`;
            
            document.querySelectorAll('.btn-primary, .btn-add-section').forEach(el => {
                el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${shadeColor(primaryColor, -20)} 100%)`;
            });
            
            // Guardar colores personalizados
            localStorage.setItem('customColors', JSON.stringify({
                primary: primaryColor,
                area: areaColor,
                header: headerColor
            }));
            
            autoSave();
        }
        
        function shadeColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }
        
        function resetColors() {
            document.getElementById('color-primary').value = '#5499c7';
            document.getElementById('color-area').value = '#85929e';
            document.getElementById('color-header').value = '#34495e';
            localStorage.removeItem('customColors');
            updateColors();
        }
        
        function loadCustomColors() {
            const saved = localStorage.getItem('customColors');
            if (saved) {
                const colors = JSON.parse(saved);
                document.getElementById('color-primary').value = colors.primary;
                document.getElementById('color-area').value = colors.area;
                document.getElementById('color-header').value = colors.header;
                updateColors();
            }
        }
        
        async function loadSavedData() {
            const savedData = localStorage.getItem('cintasPlantaDataMejorado');
            if (!savedData) {
                // Crear 3 cintas de ejemplo
                for (let i = 1; i <= 3; i++) {
                    const section = createCintaSection(i, `CINTA ${i} - Ejemplo`);
                    document.getElementById('cintas-container').appendChild(section);
                }
                cintaCounter = 3;
                return;
            }
            
            try {
                const data = JSON.parse(savedData);
                const container = document.getElementById('cintas-container');
                container.innerHTML = '';
                
                // Restaurar anotaciones
                if (data.annotations) {
                    annotations = data.annotations;
                }
                
                // Restaurar metadatos
                if (data.metadata) {
                    document.getElementById('fechaInspeccion').value = data.metadata.fechaInspeccion || '';
                    document.getElementById('tecnicoResponsable').value = data.metadata.tecnicoResponsable || '';
                    document.getElementById('ubicacionPlanta').value = data.metadata.ubicacionPlanta || '';
                    document.getElementById('estadoGeneral').value = data.metadata.estadoGeneral || '';
                    document.getElementById('observacionesGenerales').value = data.metadata.observacionesGenerales || '';
                }
                
                // Restaurar encabezado
                if (data.header) {
                    document.getElementById('empresaNombre').value = data.header.empresaNombre || '';
                    document.getElementById('plantaNombre').value = data.header.plantaNombre || '';
                    document.getElementById('contactoInfo').value = data.header.contactoInfo || '';
                    document.getElementById('emailInfo').value = data.header.emailInfo || '';
                    
                    // Cargar logo desde IndexedDB si existe
                    if (data.header.hasLogo) {
                        try {
                            const db = await openDatabase();
                            const tx = db.transaction(['images'], 'readonly');
                            const store = tx.objectStore('images');
                            const logoData = await store.get('company_logo');
                            if (logoData && logoData.base64) {
                                companyLogo = logoData.base64;
                                document.getElementById('logoPreview').src = companyLogo;
                                document.getElementById('logoPreview').style.display = 'block';
                                document.getElementById('logoPlaceholder').style.display = 'none';
                                console.log('‚úÖ Logo cargado desde IndexedDB');
                            }
                        } catch (err) {
                            console.error('Error cargando logo:', err);
                        }
                    }
                }
                
                data.cintas.forEach(cintaData => {
                    const section = createCintaSection(cintaData.id, cintaData.titulo, cintaData.area || '');
                    
                    // Restaurar √°rea si existe en datos antiguos sin este campo
                    if (cintaData.area) {
                        const areaField = section.querySelector('.area-field');
                        if (areaField) areaField.value = cintaData.area;
                    }
                    
                    // Restaurar tablas con soporte multi-columna
                    cintaData.tablas.forEach(tableData => {
                        const tableElement = section.querySelector(`[data-table-id="${tableData.tipo}"]`);
                        if (tableElement) {
                            const thead = tableElement.querySelector('thead tr');
                            const tbody = tableElement.querySelector('tbody');
                            
                            // Restaurar encabezados si existen
                            if (tableData.headers && tableData.headers.length > 1) {
                                thead.innerHTML = '';
                                tableData.headers.forEach((header, index) => {
                                    const th = document.createElement('th');
                                    if (index === 0) {
                                        th.style.width = '25%';
                                        th.textContent = header;
                                    } else {
                                        th.innerHTML = `${header}
                                            <span class="col-controls">
                                                <button class="btn-col btn-add-col" onclick="addColumnAfter(this)" title="Insertar columna">+</button>
                                                ${tableData.headers.length > 2 ? '<button class="btn-col btn-delete-col" onclick="deleteColumn(this)" title="Eliminar columna">√ó</button>' : ''}
                                            </span>`;
                                    }
                                    thead.appendChild(th);
                                });
                            }
                            
                            // Restaurar filas
                            tbody.innerHTML = '';
                            tableData.filas.forEach(fila => {
                                const row = document.createElement('tr');
                                let rowHTML = `<td class="label-col" contenteditable="true" oninput="autoSave()">${fila.label}</td>`;
                                
                                const valores = fila.valores || [fila.value]; // Compatibilidad con formato antiguo
                                valores.forEach((valor, index) => {
                                    rowHTML += `
                                        <td class="value-col">
                                            <textarea class="editable-field" rows="1" oninput="autoExpandTextarea(this); autoSave();">${valor || ''}</textarea>
                                            ${index === 0 ? `<div class="row-controls">
                                                <button class="btn-row btn-add-row" onclick="insertRowAfter(this)">+</button>
                                                <button class="btn-row btn-delete-row" onclick="deleteRow(this)">√ó</button>
                                            </div>` : ''}
                                        </td>
                                    `;
                                });
                                
                                row.innerHTML = rowHTML;
                                tbody.appendChild(row);
                                row.querySelectorAll('.editable-field').forEach(autoExpandTextarea);
                            });
                        }
                    });
                    
                    // Agregar secci√≥n al DOM primero
                    container.appendChild(section);
                    
                    // Restaurar im√°genes despu√©s de que el DOM est√© listo
                    setTimeout(() => {
                        Object.keys(cintaData.imagenes || {}).forEach(async tipo => {
                            const gridId = `grid-${cintaData.id}-${tipo}`;
                            const grid = document.getElementById(gridId);
                            
                            if (!grid) {
                                console.error(`Grid no encontrado al restaurar: ${gridId}`);
                                return;
                            }
                            
                            for (const imgData of cintaData.imagenes[tipo]) {
                                if (imgData.filepath) {
                                    await addImageToGrid(imgData.filepath, gridId, imgData.filepath);
                                    
                                    // Esperar un frame para que la imagen est√© en el DOM
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                    
                                    // Restaurar propiedades adicionales
                                    const imageItem = grid.lastElementChild;
                                    if (imageItem) {
                                        imageItem.setAttribute('data-rotation', imgData.rotation || '0');
                                        imageItem.setAttribute('data-scale', imgData.scale || '1');
                                        
                                        // Restaurar dimensiones personalizadas si existen
                                        if (imgData.width) {
                                            imageItem.style.width = imgData.width;
                                        }
                                        if (imgData.height) {
                                            imageItem.style.height = imgData.height;
                                        }
                                        
                                        // Aplicar rotaci√≥n si existe
                                        const rotation = parseInt(imgData.rotation || '0');
                                        if (rotation !== 0) {
                                            const img = imageItem.querySelector('img');
                                            if (img) img.style.transform = `rotate(${rotation}deg)`;
                                        }
                                        
                                        // Restaurar descripci√≥n
                                        if (imgData.description) {
                                            const descInput = imageItem.querySelector('.image-description');
                                            if (descInput) descInput.value = imgData.description;
                                        }
                                    }
                                }
                            }
                        });
                    }, 100);
                    cintaCounter = Math.max(cintaCounter, parseInt(cintaData.id));
                });
                
                console.log('‚úÖ Datos cargados:', data.cintas.length, 'cintas');
            } catch (e) {
                console.error('Error al cargar datos:', e);
            }
        }
        
        // ==================== EXPORTACI√ìN A PDF PROFESIONAL ====================
        function showPDFOptions() {
            const quality = document.getElementById('pdf-quality').value;
            const imageSize = document.getElementById('pdf-image-size').value;
            const settings = pdfQualitySettings[quality];
            
            const sizeMM = imageSize === 'small' ? 60 : imageSize === 'medium' ? 85 : imageSize === 'large' ? 110 : 140;
            const sizeEstimate = quality === 'ultra' ? '15-30 MB' : quality === 'high' ? '8-15 MB' : quality === 'medium' ? '4-8 MB' : '2-4 MB';
            
            if (confirm(`Exportar PDF\\n\\nCalidad: ${quality.toUpperCase()} (${Math.round(settings.quality*100)}% JPEG)\\nTama√±o im√°genes: ${sizeMM}mm (2 por fila)\\nResoluci√≥n: ${settings.scale}x\\nTodas las im√°genes incluidas\\nTama√±o estimado: ${sizeEstimate}\\n\\n¬øContinuar?`)) {
                exportToPDFProfessional();
            }
        }
        
        async function exportToPDFProfessional() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Obtener configuraci√≥n
            const template = document.getElementById('pdf-template').value;
            const qualityLevel = document.getElementById('pdf-quality').value;
            const imageSize = document.getElementById('pdf-image-size').value;
            const qualitySettings = pdfQualitySettings[qualityLevel];
            
            // Tama√±o de imagen seg√∫n selecci√≥n del usuario
            const imageSizeMM = imageSize === 'small' ? 60 : imageSize === 'medium' ? 85 : imageSize === 'large' ? 110 : 140;
            
            const templateName = template === 'ejecutivo' ? 'Ejecutivo' : template === 'tecnico' ? 'T√©cnico' : 'Completo';
            showSaveStatus(`‚è≥ Generando PDF ${templateName} (${qualityLevel}, ${imageSizeMM}mm)...`, false);
            
            // Ocultar controles temporalmente
            document.querySelectorAll('.export-buttons, .btn-small, .cinta-controls, .row-controls, .col-controls, .delete-btn, .rotate-btn, .zoom-controls, .add-photo-btn').forEach(el => {
                el.style.display = 'none';
            });
            
            let yPosition = 20;
            let firstPage = true;
            
            // ===== P√ÅGINA DE PORTADA CON LOGO Y METADATOS =====
            // Logo si existe - mantener proporci√≥n
            if (companyLogo) {
                try {
                    const logoImg = new Image();
                    logoImg.src = companyLogo;
                    await new Promise((resolve) => {
                        if (logoImg.complete) {
                            resolve();
                        } else {
                            logoImg.onload = resolve;
                            setTimeout(resolve, 100);
                        }
                    });
                    
                    // Calcular dimensiones manteniendo proporci√≥n
                    const maxLogoWidth = 70;
                    const maxLogoHeight = 25;
                    const logoRatio = logoImg.width / logoImg.height;
                    let logoW = maxLogoWidth;
                    let logoH = logoW / logoRatio;
                    
                    if (logoH > maxLogoHeight) {
                        logoH = maxLogoHeight;
                        logoW = logoH * logoRatio;
                    }
                    
                    doc.addImage(companyLogo, 'PNG', (210 - logoW) / 2, 15, logoW, logoH);
                    yPosition = 15 + logoH + 5;
                } catch (e) {
                    console.log('Error al agregar logo:', e);
                    yPosition = 20;
                }
            }
            
            // T√≠tulo principal m√°s compacto
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(52, 73, 94);
            doc.text('INFORME T√âCNICO', 105, yPosition, { align: 'center' });
            yPosition += 6;
            doc.setFontSize(14);
            doc.text('CINTAS TRANSPORTADORAS', 105, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Informaci√≥n de la empresa
            const empresaNombre = document.getElementById('empresaNombre').value;
            const plantaNombre = document.getElementById('plantaNombre').value;
            const contactoInfo = document.getElementById('contactoInfo').value;
            const emailInfo = document.getElementById('emailInfo').value;
            
            if (empresaNombre || plantaNombre) {
                doc.setFillColor(236, 240, 241);
                doc.roundedRect(20, yPosition, 170, (empresaNombre ? 5 : 0) + (plantaNombre ? 5 : 0) + (contactoInfo ? 5 : 0) + (emailInfo ? 5 : 0) + 3, 2, 2, 'F');
                doc.setFontSize(9);
                doc.setTextColor(44, 62, 80);
                doc.setFont(undefined, 'normal');
                let infoY = yPosition + 5;
                if (empresaNombre) { doc.text(`Empresa: ${empresaNombre}`, 25, infoY); infoY += 5; }
                if (plantaNombre) { doc.text(`Planta: ${plantaNombre}`, 25, infoY); infoY += 5; }
                if (contactoInfo) { doc.text(`Contacto: ${contactoInfo}`, 25, infoY); infoY += 5; }
                if (emailInfo) { doc.text(`Email: ${emailInfo}`, 25, infoY); infoY += 5; }
                yPosition = infoY + 2;
            }
            
            yPosition += 3;
            
            // Metadatos de inspecci√≥n
            const fechaInspeccion = document.getElementById('fechaInspeccion').value;
            const tecnicoResponsable = document.getElementById('tecnicoResponsable').value;
            const ubicacionPlanta = document.getElementById('ubicacionPlanta').value;
            const estadoGeneral = document.getElementById('estadoGeneral').value;
            const observacionesGenerales = document.getElementById('observacionesGenerales').value;
            
            doc.setFillColor(52, 152, 219);
            doc.roundedRect(20, yPosition, 170, 5, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('INFORMACI√ìN DE LEVANTAMIENTO', 105, yPosition + 3.5, { align: 'center' });
            yPosition += 8;
            
            doc.setFillColor(249, 249, 249);
            let metadataHeight = 3;
            if (fechaInspeccion) metadataHeight += 5;
            if (tecnicoResponsable) metadataHeight += 5;
            if (ubicacionPlanta) metadataHeight += 5;
            if (estadoGeneral) metadataHeight += 5;
            
            doc.roundedRect(20, yPosition, 170, metadataHeight, 2, 2, 'F');
            doc.setFontSize(9);
            doc.setTextColor(44, 62, 80);
            doc.setFont(undefined, 'normal');
            
            let metaY = yPosition + 5;
            if (fechaInspeccion) {
                doc.setFont(undefined, 'bold');
                doc.text('Fecha:', 25, metaY);
                doc.setFont(undefined, 'normal');
                doc.text(new Date(fechaInspeccion).toLocaleDateString('es-ES'), 55, metaY);
                metaY += 5;
            }
            if (tecnicoResponsable) {
                doc.setFont(undefined, 'bold');
                doc.text('T√©cnico:', 25, metaY);
                doc.setFont(undefined, 'normal');
                doc.text(tecnicoResponsable, 55, metaY);
                metaY += 5;
            }
            if (ubicacionPlanta) {
                doc.setFont(undefined, 'bold');
                doc.text('Ubicaci√≥n:', 25, metaY);
                doc.setFont(undefined, 'normal');
                doc.text(ubicacionPlanta, 55, metaY);
                metaY += 5;
            }
            if (estadoGeneral) {
                doc.setFont(undefined, 'bold');
                doc.text('Estado:', 25, metaY);
                doc.setFont(undefined, 'normal');
                const estadoTexto = estadoGeneral === 'operativo' ? '‚úì Operativo' :
                                    estadoGeneral === 'mantenimiento' ? '‚ö† Requiere Mantenimiento' :
                                    estadoGeneral === 'detenido' ? '‚¨õ Detenido' : '‚úó Cr√≠tico';
                doc.text(estadoTexto, 55, metaY);
                metaY += 5;
            }
            
            yPosition = metaY + 2;
            
            // Observaciones generales
            if (observacionesGenerales && observacionesGenerales.trim()) {
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                doc.text('Observaciones:', 20, yPosition);
                yPosition += 4;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                const lines = doc.splitTextToSize(observacionesGenerales, 170);
                doc.text(lines, 20, yPosition);
                yPosition += lines.length * 3.5;
            }
            
            // ===== RESUMEN EJECUTIVO =====
            // Recopilar estad√≠sticas de todas las cintas
            const sections = document.querySelectorAll('.cinta-section');
            const stats = {
                totalCintas: sections.length,
                porArea: {},
                conImagenes: 0,
                totalImagenes: 0
            };
            
            sections.forEach(section => {
                const area = section.querySelector('.area-field').value || 'Sin √°rea';
                stats.porArea[area] = (stats.porArea[area] || 0) + 1;
                
                const images = section.querySelectorAll('.image-item img');
                if (images.length > 0) {
                    stats.conImagenes++;
                    stats.totalImagenes += images.length;
                }
            });
            
            // Agregar p√°gina de resumen si hay espacio limitado, sino continuar
            if (yPosition > 180) {
                doc.addPage();
                yPosition = 20;
            } else {
                yPosition += 8;
            }
            
            // T√≠tulo del resumen
            doc.setFillColor(41, 128, 185);
            doc.roundedRect(20, yPosition, 170, 7, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN EJECUTIVO', 105, yPosition + 4.5, { align: 'center' });
            yPosition += 12;
            
            doc.setTextColor(0, 0, 0);
            
            // Estad√≠sticas principales
            doc.setFillColor(236, 240, 241);
            doc.roundedRect(20, yPosition, 80, 45, 2, 2, 'F');
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTAD√çSTICAS GENERALES', 25, yPosition + 5);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Cintas: ${stats.totalCintas}`, 25, yPosition + 12);
            doc.text(`Cintas con Im√°genes: ${stats.conImagenes}`, 25, yPosition + 18);
            doc.text(`Total de Im√°genes: ${stats.totalImagenes}`, 25, yPosition + 24);
            doc.text(`Promedio Imgs/Cinta: ${(stats.totalImagenes / stats.totalCintas).toFixed(1)}`, 25, yPosition + 30);
            
            if (estadoGeneral) {
                doc.setFont(undefined, 'bold');
                doc.text('Estado General:', 25, yPosition + 38);
                doc.setFont(undefined, 'normal');
                const estadoColor = estadoGeneral === 'operativo' ? [39, 174, 96] : 
                                   estadoGeneral === 'mantenimiento' ? [243, 156, 18] :
                                   estadoGeneral === 'detenido' ? [149, 165, 166] : [231, 76, 60];
                doc.setTextColor(estadoColor[0], estadoColor[1], estadoColor[2]);
                const estadoTexto = estadoGeneral === 'operativo' ? '‚úì Operativo' :
                                   estadoGeneral === 'mantenimiento' ? '‚ö† Mantenimiento' :
                                   estadoGeneral === 'detenido' ? '‚¨õ Detenido' : '‚úó Cr√≠tico';
                doc.text(estadoTexto, 60, yPosition + 38);
                doc.setTextColor(0, 0, 0);
            }
            
            // Gr√°fico de distribuci√≥n por √°rea (si hay m√°s de un √°rea)
            const areaKeys = Object.keys(stats.porArea);
            if (areaKeys.length > 0) {
                doc.setFillColor(236, 240, 241);
                doc.roundedRect(110, yPosition, 80, 45, 2, 2, 'F');
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('DISTRIBUCI√ìN POR √ÅREA', 115, yPosition + 5);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                
                let areaY = yPosition + 12;
                const colors = [
                    [52, 152, 219],   // Azul
                    [46, 204, 113],   // Verde
                    [155, 89, 182],   // Morado
                    [241, 196, 15],   // Amarillo
                    [231, 76, 60],    // Rojo
                    [26, 188, 156],   // Turquesa
                    [230, 126, 34]    // Naranja
                ];
                
                for (let index = 0; index < areaKeys.length; index++) {
                    const area = areaKeys[index];
                    const count = stats.porArea[area];
                    const percentage = ((count / stats.totalCintas) * 100).toFixed(0);
                    const color = colors[index % colors.length];
                    
                    // Barra de color
                    doc.setFillColor(color[0], color[1], color[2]);
                    const barWidth = (count / stats.totalCintas) * 60;
                    doc.roundedRect(115, areaY - 2, barWidth, 4, 1, 1, 'F');
                    
                    // Texto
                    doc.setTextColor(0, 0, 0);
                    const areaText = area.length > 20 ? area.substring(0, 20) + '...' : area;
                    doc.text(`${areaText}: ${count} (${percentage}%)`, 115, areaY + 5);
                    areaY += 7;
                    
                    if (areaY > yPosition + 43) break; // M√°ximo 5 √°reas
                }
            }
            
            yPosition += 50;
            
            // Si es PDF Ejecutivo, terminar aqu√≠ (solo resumen)
            if (template === 'ejecutivo') {
                // Pie de p√°gina
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Pagina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                }
                
                // Restaurar controles
                document.querySelectorAll('.export-buttons, .btn-small, .cinta-controls, .row-controls, .col-controls, .delete-btn, .rotate-btn, .zoom-controls, .add-photo-btn').forEach(el => {
                    el.style.display = '';
                });
                
                // Generar nombre de archivo con fecha
                const fechaArchivo = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                doc.save(`Informe_Ejecutivo_${fechaArchivo.replace(/\//g, '-')}.pdf`);
                showSaveStatus('‚úÖ PDF Ejecutivo generado correctamente', true);
                return;
            }
            
            // Continuar en la misma p√°gina si hay espacio, sino nueva p√°gina
            yPosition += 8;
            if (yPosition > 200) {
                doc.addPage();
                yPosition = 20;
            }
            
            // Procesar cada cinta (para PDF T√©cnico o Completo)
            
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                const area = section.querySelector('.area-field').value;
                const title = section.querySelector('.cinta-title-editable').value;
                
                // Nueva p√°gina si no es la primera cinta
                if (i > 0) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Mostrar √°rea si existe
                if (area && area.trim() !== '') {
                    doc.setFillColor(133, 146, 158);
                    doc.roundedRect(10, yPosition, 50, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(area.toUpperCase(), 12, yPosition + 4.5);
                    yPosition += 10;
                    doc.setTextColor(0, 0, 0);
                }
                
                // T√≠tulo de cinta
                doc.setFillColor(52, 73, 94);
                doc.rect(10, yPosition, 190, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(title, 15, yPosition + 5.5);
                yPosition += 12;
                doc.setTextColor(0, 0, 0);
                
                // Procesar tablas (siempre incluidas en PDF T√©cnico y Completo)
                const tables = section.querySelectorAll('table');
                for (const table of tables) {
                    const isMotor = table.classList.contains('table-motor');
                    const subtitle = isMotor ? 'MOTORREDUCTOR' : 'ESPECIFICACIONES DE BANDA';
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(subtitle, 15, yPosition);
                    yPosition += 6;
                    
                    const tableData = [];
                    const headers = [];
                    
                    // Obtener encabezados
                    table.querySelectorAll('thead th').forEach(th => {
                        const text = th.textContent.split('\n')[0].trim();
                        headers.push(text);
                    });
                    
                    // Obtener datos
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = [row.querySelector('.label-col').textContent.trim()];
                        row.querySelectorAll('.editable-field').forEach(field => {
                            rowData.push(field.value || '');
                        });
                        tableData.push(rowData);
                    });
                    
                    // Calcular anchos
                    const totalWidth = 180;
                    const labelWidth = 50;
                    const valueWidth = (totalWidth - labelWidth) / (headers.length - 1);
                    const columnStyles = { 0: { cellWidth: labelWidth, fontStyle: 'bold', fillColor: [248, 249, 250] } };
                    for (let j = 1; j < headers.length; j++) {
                        columnStyles[j] = { cellWidth: valueWidth };
                    }
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [headers],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 9, cellPadding: 3, lineColor: [220, 220, 220], lineWidth: 0.1 },
                        headStyles: { fillColor: [189, 195, 199], textColor: [44, 62, 80], fontStyle: 'bold', fontSize: 9 },
                        columnStyles: columnStyles,
                        margin: { left: 15, right: 15 }
                    });
                    
                    yPosition = doc.lastAutoTable.finalY + 8;
                }
                
                // Agregar im√°genes (solo en PDF Completo)
                if (template === 'completo') {
                    const grids = section.querySelectorAll('.image-grid');
                    for (const grid of grids) {
                        const images = grid.querySelectorAll('.image-item img');
                        if (images.length > 0) {
                            const gridType = grid.id.includes('banda') ? 'Banda y Sprockets' : 'Motorreductor';
                            
                            if (yPosition > 220) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text(`Imagenes - ${gridType}`, 15, yPosition);
                            yPosition += 5;
                            
                            let xPos = 15;
                            let rowHeight = 0;
                            let imagesInRow = 0;
                            const maxImagesPerRow = 2; // M√°ximo 2 im√°genes por fila para que se vean m√°s grandes
                            
                            for (let j = 0; j < images.length; j++) { // Mostrar TODAS las im√°genes
                                try {
                                    const img = images[j];
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Esperar a que la imagen cargue
                                await new Promise((resolve) => {
                                    if (img.complete) {
                                        resolve();
                                    } else {
                                        img.onload = resolve;
                                        setTimeout(resolve, 100);
                                    }
                                });
                                
                                // Dimensiones m√°ximas en el PDF (en mm) - seg√∫n selecci√≥n del usuario
                                const maxDisplayW = imageSizeMM;
                                const maxDisplayH = Math.floor(imageSizeMM * 0.75); // Mantener proporci√≥n razonable
                                
                                // Obtener dimensiones originales de la imagen
                                let originalW = img.naturalWidth || img.width;
                                let originalH = img.naturalHeight || img.height;
                                
                                // Calcular dimensiones de visualizaci√≥n en PDF manteniendo proporci√≥n
                                let displayW = originalW;
                                let displayH = originalH;
                                const ratio = Math.min(maxDisplayW / originalW, maxDisplayH / originalH);
                                displayW = Math.floor(originalW * ratio);
                                displayH = Math.floor(originalH * ratio);
                                
                                // Usar resoluci√≥n configurada
                                const scale = qualitySettings.scale;
                                const canvasW = displayW * scale;
                                const canvasH = displayH * scale;
                                
                                canvas.width = canvasW;
                                canvas.height = canvasH;
                                
                                // Fondo blanco
                                ctx.fillStyle = 'white';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Configurar alta calidad de renderizado
                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';
                                
                                // Dibujar la imagen en el canvas con la resoluci√≥n aumentada
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                
                                // Dibujar anotaciones si existen
                                const imageItem = img.closest('.image-item');
                                const imageId = imageItem.getAttribute('data-filepath');
                                if (annotations[imageId] && annotations[imageId].length > 0) {
                                    // Escalar las anotaciones al tama√±o del canvas
                                    const scaleX = canvas.width / img.width;
                                    const scaleY = canvas.height / img.height;
                                    
                                    annotations[imageId].forEach(ann => {
                                        ctx.strokeStyle = ann.color;
                                        ctx.fillStyle = ann.color;
                                        ctx.lineWidth = 3 * scale;
                                        
                                        if (ann.type === 'arrow') {
                                            const x1 = ann.x1 * scaleX;
                                            const y1 = ann.y1 * scaleY;
                                            const x2 = ann.x2 * scaleX;
                                            const y2 = ann.y2 * scaleY;
                                            drawArrow(ctx, x1, y1, x2, y2, ann.color);
                                        } else if (ann.type === 'circle') {
                                            ctx.beginPath();
                                            ctx.arc(ann.x * scaleX, ann.y * scaleY, ann.radius * scaleX, 0, 2 * Math.PI);
                                            ctx.stroke();
                                        } else if (ann.type === 'rect') {
                                            ctx.strokeRect(ann.x * scaleX, ann.y * scaleY, ann.width * scaleX, ann.height * scaleY);
                                        } else if (ann.type === 'text') {
                                            ctx.font = (16 * scale) + 'px Arial';
                                            ctx.fillText(ann.text, ann.x * scaleX, ann.y * scaleY);
                                        }
                                    });
                                }
                                
                                // Convertir a JPEG con calidad configurada
                                const imgData = canvas.toDataURL('image/jpeg', qualitySettings.quality);
                                
                                // Salto de fila si no cabe o si ya hay 2 im√°genes
                                if (xPos + displayW > 185 || imagesInRow >= maxImagesPerRow) {
                                    xPos = 15;
                                    yPosition += rowHeight + 5;
                                    rowHeight = 0;
                                    imagesInRow = 0;
                                    
                                    // Nueva p√°gina si no cabe
                                    if (yPosition + displayH > 270) {
                                        doc.addPage();
                                        yPosition = 20;
                                        xPos = 15;
                                    }
                                }
                                
                                doc.addImage(imgData, 'JPEG', xPos, yPosition, displayW, displayH);
                                
                                // Agregar descripci√≥n si existe (reutilizando imageItem)
                                const descriptionInput = imageItem ? imageItem.querySelector('.image-description') : null;
                                if (descriptionInput && descriptionInput.value.trim()) {
                                    doc.setFontSize(7);
                                    doc.setFont(undefined, 'italic');
                                    doc.setTextColor(80, 80, 80);
                                    const descLines = doc.splitTextToSize(descriptionInput.value, displayW);
                                    doc.text(descLines, xPos, yPosition + displayH + 2);
                                    doc.setTextColor(0, 0, 0);
                                    const descHeight = descLines.length * 2.5;
                                    rowHeight = Math.max(rowHeight, displayH + descHeight + 2);
                                } else {
                                    rowHeight = Math.max(rowHeight, displayH);
                                }
                                
                                xPos += displayW + 5;
                                imagesInRow++;
                                
                            } catch (e) {
                                console.error('Error con imagen:', e);
                            }
                        }
                        
                        yPosition += rowHeight + 8;
                    }
                }
                } // Fin del if template === 'completo'
            }
            
            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Pagina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
            }
            
            // Restaurar controles
            document.querySelectorAll('.export-buttons, .btn-small, .cinta-controls, .row-controls, .col-controls, .delete-btn, .rotate-btn, .zoom-controls, .add-photo-btn').forEach(el => {
                el.style.display = '';
            });
            
            // Generar nombre de archivo con fecha y template
            const fechaArchivo = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const templateSuffix = template === 'ejecutivo' ? '_Ejecutivo' : template === 'tecnico' ? '_Tecnico' : '';
            doc.save(`Informe_Cintas${templateSuffix}_${fechaArchivo.replace(/\//g, '-')}.pdf`);
            showSaveStatus('‚úÖ PDF generado correctamente', true);
        }
        
        // ==================== EXPORTAR/IMPORTAR DATOS COMPLETOS CON IM√ÅGENES ====================
        async function exportDataWithImages() {
            showSaveStatus('‚è≥ Exportando datos e im√°genes...', false);
            
            try {
                // Obtener datos de texto de localStorage
                const textData = localStorage.getItem('cintasPlantaDataMejorado');
                if (!textData) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                // Obtener todas las im√°genes de IndexedDB
                const db = await openDatabase();
                const imageIds = [];
                const imagesData = {};
                
                // Recopilar IDs de im√°genes de los datos
                const parsedData = JSON.parse(textData);
                parsedData.cintas.forEach(cinta => {
                    Object.values(cinta.imagenes || {}).forEach(imageArray => {
                        imageArray.forEach(img => {
                            if (img.filepath) {
                                imageIds.push(img.filepath);
                            }
                        });
                    });
                });
                
                // Agregar logo de empresa si existe
                if (parsedData.header && parsedData.header.hasLogo) {
                    imageIds.push('company_logo');
                }
                
                // Obtener datos de cada imagen
                for (const imageId of imageIds) {
                    const imageData = await loadImageFromIndexedDB(imageId);
                    if (imageData) {
                        let base64Data;
                        
                        // Si ya est√° en base64 completo (con data:image...)
                        if (typeof imageData.data === 'string' && imageData.data.startsWith('data:')) {
                            base64Data = imageData.data;
                        }
                        // Si tiene propiedad base64 (como el logo)
                        else if (imageData.base64) {
                            base64Data = imageData.base64;
                        }
                        // Si es base64 puro (sin prefijo data:)
                        else if (typeof imageData.data === 'string') {
                            // Ya es base64, solo agregar prefijo para el JSON
                            const mimeType = imageData.type || 'image/jpeg';
                            base64Data = `data:${mimeType};base64,${imageData.data}`;
                        }
                        // Si es ArrayBuffer
                        else if (imageData.data instanceof ArrayBuffer) {
                            const base64 = arrayBufferToBase64(imageData.data);
                            const mimeType = imageData.type || 'image/jpeg';
                            base64Data = `data:${mimeType};base64,${base64}`;
                        }
                        else {
                            console.error('Formato de imagen desconocido:', imageId, typeof imageData.data);
                            continue;
                        }
                        
                        imagesData[imageId] = {
                            data: base64Data,
                            type: imageData.type,
                            name: imageData.name,
                            size: imageData.size
                        };
                        console.log(`üì¶ Empaquetada: ${imageId} (${(imageData.size/1024).toFixed(2)} KB)`);
                    } else {
                        console.warn(`‚ö†Ô∏è Imagen no encontrada: ${imageId}`);
                    }
                }
                
                // Crear objeto completo
                const completeData = {
                    version: '3.0.0',
                    exported: new Date().toISOString(),
                    textData: parsedData,
                    images: imagesData,
                    imageCount: Object.keys(imagesData).length
                };
                
                // Descargar como JSON
                const blob = new Blob([JSON.stringify(completeData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CintasPlanta_Completo_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showSaveStatus(`‚úÖ Exportado: ${parsedData.cintas.length} cintas, ${Object.keys(imagesData).length} im√°genes`, true);
            } catch (e) {
                console.error('Error exportando:', e);
                alert('Error al exportar datos: ' + e.message);
            }
        }
        
        async function importDataWithImages(input) {
            if (!input.files || !input.files[0]) return;
            
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esto REEMPLAZAR√Å todos los datos actuales.\n\n¬øEst√°s seguro de continuar?')) {
                input.value = '';
                return;
            }
            
            showSaveStatus('‚è≥ Importando datos e im√°genes...', false);
            
            try {
                const file = input.files[0];
                const text = await file.text();
                const completeData = JSON.parse(text);
                
                // Validar formato
                if (!completeData.textData || !completeData.images) {
                    alert('Archivo inv√°lido. Debe ser un archivo exportado por esta aplicaci√≥n.');
                    return;
                }
                
                // Guardar im√°genes en IndexedDB
                let importedImages = 0;
                for (const [imageId, imageData] of Object.entries(completeData.images)) {
                    try {
                        // Guardar directamente el base64 (m√°s confiable)
                        if (imageId === 'company_logo') {
                            // El logo tiene formato especial
                            await saveImageToIndexedDB(imageId, {
                                id: 'company_logo',
                                base64: imageData.data
                            });
                        } else {
                            await saveImageToIndexedDB(imageId, {
                                data: imageData.data, // Ya es base64
                                type: imageData.type,
                                name: imageData.name,
                                size: imageData.size
                            });
                        }
                        importedImages++;
                    } catch (e) {
                        console.error('Error importando imagen:', imageId, e);
                    }
                }
                
                // Guardar datos de texto en localStorage
                localStorage.setItem('cintasPlantaDataMejorado', JSON.stringify(completeData.textData));
                
                // Recargar p√°gina
                showSaveStatus(`‚úÖ Importado: ${completeData.textData.cintas.length} cintas, ${importedImages} im√°genes`, true);
                setTimeout(() => location.reload(), 1500);
                
            } catch (e) {
                console.error('Error importando:', e);
                alert('Error al importar datos: ' + e.message);
            }
            
            input.value = '';
        }
        
        // Funciones auxiliares para conversi√≥n base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            document.querySelectorAll('.cinta-section').forEach((section, index) => {
                const data = [];
                
                // √Årea y t√≠tulo
                const area = section.querySelector('.area-field').value;
                const title = section.querySelector('.cinta-title-editable').value;
                if (area) data.push([area]);
                data.push([title]);
                data.push([]);
                
                // Procesar cada tabla con soporte multi-columna
                section.querySelectorAll('table').forEach(table => {
                    // Obtener encabezados
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim().split('\n')[0]);
                    data.push(headers);
                    
                    // Obtener filas con todas las columnas
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = [];
                        rowData.push(row.querySelector('.label-col').textContent.trim());
                        
                        // Obtener todos los valores de las columnas
                        row.querySelectorAll('.value-col .editable-field').forEach(field => {
                            rowData.push(field.value);
                        });
                        
                        data.push(rowData);
                    });
                    data.push([]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `Cinta ${index + 1}`);
            });
            
            XLSX.writeFile(wb, 'Informe_Cintas_Transportadoras.xlsx');
            showSaveStatus('‚úÖ Excel exportado correctamente', true);
        }
        
        // ==================== INICIALIZACI√ìN ====================
        window.addEventListener('DOMContentLoaded', async function() {
            // Detectar si Tracking Prevention est√° activo
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                alert('‚ö†Ô∏è TRACKING PREVENTION DETECTADO\n\n' +
                      'Tu navegador est√° bloqueando el almacenamiento local.\n\n' +
                      'SOLUCI√ìN para Microsoft Edge:\n' +
                      '1. Haz clic en el icono de escudo üõ°Ô∏è en la barra de direcciones\n' +
                      '2. Desactiva "Prevenci√≥n de seguimiento para este sitio"\n' +
                      '3. Recarga la p√°gina (F5)\n\n' +
                      'O usa Chrome/Firefox sin tracking prevention.');
                console.error('‚ö†Ô∏è Tracking Prevention bloqueando almacenamiento');
            }
            
            await loadSavedData();
            loadCustomColors(); // Cargar colores personalizados
            
            // Auto-expandir textareas existentes
            document.querySelectorAll('.editable-field').forEach(autoExpandTextarea);
            
            console.log('‚úÖ Sistema inicializado con IndexedDB');
            console.log('üì¶ Las im√°genes se guardan autom√°ticamente en tu navegador');
            console.log('üíæ Textos en localStorage, Im√°genes en IndexedDB (sin l√≠mite)');
            console.log('üéØ Selector de calidad PDF disponible');
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                clearTimeout(saveTimeout);
                saveAllData();
            }
        });
    </script>
</body>
</html>
